<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <title>健康問卷填寫</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: "Microsoft JhengHei", "PingFang TC", "Helvetica Neue", Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            color: #333;
        }

        .container {
            max-width: 500px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            padding: 30px 20px;
            text-align: center;
        }

        .header h1 {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 10px;
        }

        .header p {
            font-size: 16px;
            opacity: 0.9;
        }

        .form-container {
            padding: 30px 20px;
        }

        .form-group {
            margin-bottom: 30px;
            background: #f8f9fa;
            border-radius: 15px;
            padding: 20px;
            border: 2px solid #e9ecef;
        }

        .form-group:hover {
            border-color: #4CAF50;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.2);
        }

        .question-label {
            display: block;
            font-size: 20px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 20px;
            line-height: 1.4;
        }

        .radio-group {
            display: flex;
            gap: 20px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .radio-option {
            position: relative;
            flex: 1;
            min-width: 120px;
        }

        .radio-option input[type="radio"] {
            display: none;
        }

        .radio-option label {
            display: block;
            padding: 20px 15px;
            background: white;
            border: 3px solid #ddd;
            border-radius: 12px;
            text-align: center;
            font-size: 24px;
            font-weight: bold;
            color: #666;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .radio-option input[type="radio"]:checked+label {
            background: #4CAF50;
            color: white;
            border-color: #4CAF50;
            transform: scale(1.05);
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .radio-option label:hover {
            border-color: #4CAF50;
            transform: scale(1.02);
        }

        .text-input-group {
            margin-bottom: 30px;
        }

        .text-input-group label {
            display: block;
            font-size: 18px;
            font-weight: bold;
            color: #2c3e50;
            margin-bottom: 15px;
            line-height: 1.4;
        }

        .text-input {
            width: 100%;
            padding: 20px;
            font-size: 18px;
            border: 3px solid #ddd;
            border-radius: 12px;
            background: white;
            transition: all 0.3s ease;
        }

        .text-input:focus {
            outline: none;
            border-color: #4CAF50;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .submit-btn {
            width: 100%;
            padding: 25px;
            font-size: 22px;
            font-weight: bold;
            background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
            color: white;
            border: none;
            border-radius: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
        }

        .submit-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(76, 175, 80, 0.4);
        }

        .submit-btn:active {
            transform: translateY(0);
        }

        .submit-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 10px;
            font-size: 18px;
            text-align: center;
            font-weight: bold;
        }

        .success {
            background: #d4edda;
            color: #155724;
            border: 2px solid #c3e6cb;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            border: 2px solid #f5c6cb;
        }

        .loading {
            background: #d1ecf1;
            color: #0c5460;
            border: 2px solid #bee5eb;
        }

        /* 響應式設計 */
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }

            .header h1 {
                font-size: 24px;
            }

            .question-label {
                font-size: 18px;
            }

            .radio-option label {
                font-size: 20px;
                padding: 15px 10px;
                min-height: 70px;
            }

            .submit-btn {
                font-size: 20px;
                padding: 20px;
            }

            .form-container {
                padding: 20px 15px;
            }

            .form-group {
                padding: 15px;
                margin-bottom: 20px;
            }
        }

        /* 動畫效果 */
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-group {
            animation: fadeIn 0.5s ease-out;
        }

        .form-group:nth-child(1) {
            animation-delay: 0.1s;
        }

        .form-group:nth-child(2) {
            animation-delay: 0.2s;
        }

        .form-group:nth-child(3) {
            animation-delay: 0.3s;
        }

        .form-group:nth-child(4) {
            animation-delay: 0.4s;
        }

        .form-group:nth-child(5) {
            animation-delay: 0.5s;
        }
    </style>
</head>

<body>
    <div class="container">
        <!-- 註冊表單區塊 -->
        <div id="registerSection" style="display:none;">
            <div class="header">
                <h1>首次註冊</h1>
                <p>請先完成註冊，才能填寫健康問卷</p>
            </div>
            <form id="registerForm" class="form-container">
                <div class="form-group">
                    <label class="question-label">LINE 名稱</label>
                    <div class="text-input-group">
                        <span id="lineName"></span>
                    </div>
                </div>
                <div class="form-group">
                    <label class="question-label">姓名</label>
                    <input type="text" name="name" class="text-input" required>
                </div>
                <div class="form-group">
                    <label class="question-label">性別</label>
                    <select name="gender" class="text-input" required>
                        <option value="">請選擇</option>
                        <option value="male">男</option>
                        <option value="female">女</option>
                        <option value="other">其他</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="question-label">生日</label>
                    <input type="date" name="birthday" class="text-input" required>
                </div>
                <div class="form-group">
                    <label class="question-label">年齡</label>
                    <input type="number" name="age" id="ageInput" class="text-input" readonly>
                </div>
                <button type="submit" class="submit-btn">註冊</button>
            </form>
            <div id="registerMsg"></div>
        </div>
        <!-- 問卷區塊 -->
        <div id="surveySection" style="display:none;">
            <div class="header">
                <h1>健康問卷填寫</h1>
                <p id="welcomeMsg"></p>
            </div>
            <div class="form-container">
                <form id="surveyForm">
                    <div class="form-group">
                        <label class="question-label">1. 是否有喝水500cc</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="q1" value="V" id="q1_v">
                                <label for="q1_v">✓ 有</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="q1" value="X" id="q1_x">
                                <label for="q1_x">✗ 沒有</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="question-label">2. 是否有吃藥</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="q2" value="V" id="q2_v">
                                <label for="q2_v">✓ 有</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="q2" value="X" id="q2_x">
                                <label for="q2_x">✗ 沒有</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="question-label">3. 是否有拉筋</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="q3" value="V" id="q3_v">
                                <label for="q3_v">✓ 有</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="q3" value="X" id="q3_x">
                                <label for="q3_x">✗ 沒有</label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="question-label">4. 是否有超慢跑</label>
                        <div class="radio-group">
                            <div class="radio-option">
                                <input type="radio" name="q4" value="V" id="q4_v">
                                <label for="q4_v">✓ 有</label>
                            </div>
                            <div class="radio-option">
                                <input type="radio" name="q4" value="X" id="q4_x">
                                <label for="q4_x">✗ 沒有</label>
                            </div>
                        </div>
                    </div>

                    <div class="text-input-group">
                        <label class="question-label">有沒有什麼想跟護理師說的話（限20字）</label>
                        <input type="text" name="remark" maxlength="20" class="text-input" placeholder="請輸入您的留言...">
                    </div>

                    <button type="submit" class="submit-btn" id="submitBtn">送出問卷</button>
                </form>
                <div id="msg"></div>
            </div>
        </div>
    </div>

    <script>
        let userLineId = null;
        let userLineName = null;
        let userProfile = null;

        function getCurrentSlot() {
            const now = new Date();
            const hour = now.getHours();
            if (hour < 13) return "10:00";
            if (hour < 17) return "13:00";
            return "17:00";
        }

        // LIFF 初始化與用戶同步
        async function initLiffAndSync() {
            await liff.init({ liffId: "YOUR_LIFF_ID" });
            if (!liff.isLoggedIn()) {
                liff.login();
                return;
            }
            const profile = await liff.getProfile();
            userLineId = profile.userId;
            userLineName = profile.displayName;
            // 呼叫 /api/user/sync
            const res = await fetch("/api/user/sync", {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({ lineId: userLineId, name: userLineName })
            });
            const result = await res.json();
            if (result.status === 'new') {
                // 新用戶，顯示註冊表單
                document.getElementById("registerSection").style.display = "block";
                document.getElementById("surveySection").style.display = "none";
                document.getElementById("lineName").textContent = userLineName;
            } else if (result.status === 'exist') {
                // 已存在，顯示問卷與歡迎詞
                userProfile = result.user;
                document.getElementById("registerSection").style.display = "none";
                document.getElementById("surveySection").style.display = "block";
                document.getElementById("welcomeMsg").textContent = `你好，${userProfile.name || userLineName}`;
            }
        }

        function showMessage(message, type) {
            const msgDiv = document.getElementById("msg");
            msgDiv.innerHTML = `<div class="message ${type}">${message}</div>`;

            if (type === 'success') {
                setTimeout(() => {
                    msgDiv.innerHTML = '';
                }, 3000);
            }
        }

        function setLoading(loading) {
            const submitBtn = document.getElementById("submitBtn");
            if (loading) {
                submitBtn.disabled = true;
                submitBtn.textContent = "送出中...";
                showMessage("正在送出問卷，請稍候...", "loading");
            } else {
                submitBtn.disabled = false;
                submitBtn.textContent = "送出問卷";
            }
        }

        document.addEventListener("DOMContentLoaded", () => {
            initLiffAndSync();

            // 年齡自動計算
            const birthdayInput = document.querySelector('#registerForm input[name="birthday"]');
            const ageInput = document.getElementById('ageInput');
            if (birthdayInput) {
                birthdayInput.addEventListener('change', function () {
                    const birthDate = new Date(this.value);
                    const today = new Date();
                    let age = today.getFullYear() - birthDate.getFullYear();
                    const m = today.getMonth() - birthDate.getMonth();
                    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
                        age--;
                    }
                    ageInput.value = age;
                });
            }

            // 註冊表單送出
            document.getElementById("registerForm").addEventListener("submit", async function (e) {
                e.preventDefault();
                const form = e.target;
                const data = {
                    lineId: userLineId,
                    name: form.name.value,
                    gender: form.gender.value,
                    birthday: form.birthday.value,
                    age: form.age.value
                };
                try {
                    const res = await fetch("/api/user/sync", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });
                    const result = await res.json();
                    if (result.success) {
                        document.getElementById("registerMsg").textContent = "註冊成功，請繼續填寫問卷！";
                        document.getElementById("registerSection").style.display = "none";
                        document.getElementById("surveySection").style.display = "block";
                        document.getElementById("welcomeMsg").textContent = `你好，${form.name}`;
                    } else {
                        document.getElementById("registerMsg").textContent = "註冊失敗：" + (result.error || "");
                    }
                } catch (err) {
                    document.getElementById("registerMsg").textContent = "系統錯誤，請稍後再試。";
                }
            });

            document.getElementById("surveyForm").addEventListener("submit", async function (e) {
                e.preventDefault();

                const form = e.target;
                const data = {
                    lineId: userLineId,
                    slot: getCurrentSlot(),
                    q1: form.q1.value || null,
                    q2: form.q2.value || null,
                    q3: form.q3.value || null,
                    q4: form.q4.value || null,
                    remark: form.remark.value || null
                };

                // 檢查是否所有問題都已回答
                if (!data.q1 || !data.q2 || !data.q3 || !data.q4) {
                    showMessage("請回答所有問題後再送出", "error");
                    return;
                }

                setLoading(true);

                try {
                    const res = await fetch("/api/survey/submit", {
                        method: "POST",
                        headers: { "Content-Type": "application/json" },
                        body: JSON.stringify(data)
                    });

                    const result = await res.json();

                    if (result.success) {
                        showMessage("✓ 問卷填寫成功！感謝您的配合", "success");
                        form.reset();
                    } else {
                        showMessage("✗ 填寫失敗：" + (result.error || '請稍後再試'), "error");
                    }
                } catch (err) {
                    console.error('送出失敗:', err);
                    showMessage("✗ 系統錯誤，請檢查網路連線後再試", "error");
                } finally {
                    setLoading(false);
                }
            });

            // 為文字輸入框添加字數提示
            const remarkInput = document.querySelector('input[name="remark"]');
            if (remarkInput) {
                remarkInput.addEventListener('input', function () {
                    const remaining = 20 - this.value.length;
                    if (remaining < 0) {
                        this.value = this.value.substring(0, 20);
                    }
                });
            }
        });
    </script>
</body>

</html>